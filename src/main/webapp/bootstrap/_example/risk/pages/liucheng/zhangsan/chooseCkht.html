<!DOCTYPE HTML>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<!--Bootstrap 不支持 IE 古老的兼容模式。为了让 IE 浏览器运行最新的渲染模式建议添加一下meta-->
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<!--自适应设备宽度-->
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
		<title>外贸综合服务企业出口退税风险管控信息系统-新建任务选择出口合同</title>
		<meta name="Keywords" content="外贸综合服务企业出口退税风险管控信息系统">
		<meta name="description" content="外贸综合服务企业出口退税风险管控信息系统">
		<link rel="stylesheet" href="../../../static/plugins/bootstrap-3.3.7/css/bootstrap.min.css"/>
		<script type="text/javascript" src="../../../static/plugins/jquery-2.1.1/jquery-2.1.1.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="../../../static/plugins/font-awesome-4.7.0/css/font-awesome.css"/><!-- icon字体图标 -->
		<link rel="stylesheet" href="../../../static/plugins/bootstrap-table-1.11.1/bootstrap-table.css"/><!-- 表格 -->
		<script type="text/javascript" src="../../../static/plugins/bootstrap-table-1.11.1/bootstrap-table.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-table-1.11.1/extensions/export/bootstrap-table-export.js"></script><!-- 表格导出 -->
		<script type="text/javascript" src="../../../static/plugins/tableExport.jquery.plugin/tableExport.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-table-1.11.1/locale/bootstrap-table-zh-CN.js"></script>
		<script type="text/javascript" src="../../../static/plugins/jquery-validation-1.17.0/jquery.validate.js"></script><!-- 表单验证 -->
		<script type="text/javascript" src="../../../static/plugins/jquery-validation-1.17.0/jquery.validate.extends.js"></script>
		<link rel="stylesheet" href="../../../static/plugins/poshytip-1.2/tip-yellowsimple/tip-yellowsimple.css" type="text/css"/>
		<script type="text/javascript" src="../../../static/plugins/poshytip-1.2/jquery.poshytip.js"></script>
		<script src="../../../static/plugins/jquery.nicescroll-3.7.6/jquery.nicescroll.js"></script><!-- 美化滚动条 -->
		<script type="text/javascript" src="../../../static/js/common.js"></script><!-- 自定义公用js -->
		<link rel="stylesheet" href="../../../static/css/common.css"/><!-- 自定义公用css -->
		<link rel="stylesheet" href="../../../static/plugins/layer-v3.1.0/theme/default/layer.css"/><!-- 弹窗 -->
		<script type="text/javascript" src="../../../static/plugins/layer-v3.1.0/layer.js"></script>
		
	</head>
	<body>
	<div class="layerBodyBg">
		<!-- 普通查询 -->
		<form id="thSearchForm" class="form-inline commSearch searchBox" style="padding:0">
			<div class="row">
				<div class="col-xs-6" id="advSearchBox"></div>
				<div class="col-xs-6 text-right">
					<button type="button" class="btn btn-ckts btn-xs search" title="查询" id="thSearchBtn"><i class="glyphicon glyphicon-search"></i>查询</button>
					<button type="reset" class="btn btn-ckts btn-xs" title="重置"><i class="glyphicon glyphicon-refresh"></i>重置</button>
					<button type="button"  class="btn btn-ckts btn-xs" title="确定" id = "queDingChoose"><i class="glyphicon glyphicon-ok"></i>确定</button>
					<button type="button"  class="btn btn-ckts btn-xs" title="撤销"><i class="glyphicon glyphicon-share-alt"></i>撤销</button>
					<!-- <button type="button" class="btn btn-ckts btn-xs cancel" title="取消" ><i class="glyphicon glyphicon-remove"></i>取消</button> -->
				</div>
			</div>			
		</form>
		<!-- 普通查询 -->
		<div class="tableBox">
			<table id="table" data-advanced-search="true" data-id-table="advancedTable" class="myTable table-condensed hgTable"></table>
		</div>
	</div>
	
	<script type="text/javascript">
		var ckhtColumns = [ 
			/*
			{
				//field : 'state',
				align:'center',
				checkbox : true
			},
			*/
			{
				title : '序号',
				align:'center',
				formatter : function(value,row,index){
					/*
					var page = $table.bootstrapTable("getPage");
					var pageSize = page.pageSize,pageNumber = page.pageNumber;
					return page.pageSize*(page.pageNumber-1)+index+1;
					*/
					return '<font key="'+row.ckht+'">' + (index + 1) + '</font>';
				}
			},
			{
				title : '合同ID',
				align:'center',
				field : 'ckht',
				visible : false
			},
			{
				title : '合同编号',
				align:'center',
				field : 'contractCode',
				align : 'left'
			}, 
			{
				title : '合同名称',
				align:'center',
				field : 'contractName',
				align : 'left',
				formatter : labelTrimFormatter
			}, 
			{
				title : '签订日期',
				align:'center',
				field : 'signDate'
			}, 
			{
				title : '买方',
				align:'center',
				field : 'buyerName',
				align : 'left',
				formatter : labelTrimFormatter
			}, 
			{
				title : '卖方',
				align:'center',
				field : 'sellerName',
				align : 'left',
				formatter : labelTrimFormatter
			}, 
			{
				title : '出口国别',
				align:'center',
				field : 'exportCountry',
				formatter : function(value,row,index){
					if(value){
						return getDict("nation",value);
					}else{
						return "";
					}
				}
				
			}, 
			{
				title : '贸易方式',
				align:'center',
				field : 'serviceType',
				formatter : function(value,row,index){
					if(value){
						return getDict("maoyifs",value);
					}else{
						return "";
					}
				}
			}
		];
		
		var branch = "0";
		
		$(function(){
			var $table = $("#table");
			var selection=null;
			var $buttons = $("#advSearchBox").next().find("button");
			
			formGenerator({
				container :  "advSearchBox",
				columns : [
					{
						col : "contractCode",
						type : "text",
						label : "合同编号"
					},
					{
						col : "contractName",
						type : "text",
						label : "合同名称"
					},
					{
						col : "exportCountry",
						label : "出口国别",
						type : "select",
						options : getDictsExt("nation")
					}
				]
			},"query");
			
			function selectDefaultRow(data){
				var ckhtVal = parentTabWindow.$("#renwuForm").find(":input[name='ckht']").val();
				if(ckhtVal){
					for(var i=0;i<data.length;i++){
						var item = data[i];
						if(item.ckht==ckhtVal){
							selection = item;
							//$table.bootstrapTable("checkBy",{field:"ckht",values:[item.chkt]});
							$table.find("tbody tr").eq(i).find("td:eq(0)").click();
							break;
						}
					}
				}
			}
			
			/*
			$("#thSearchBtn").on("click",function(){
				queryData("../../../../chuKouHeTong/findPageByCondition?branch=0");
				//queryData({});
			}).trigger("click");
			*/
			/**
			 @author 周小建
			 @time 2017-11-01
			 @description “海关商品代码库”查询按钮的单击事件处理函数，通过条件过滤结果数据，构建和加载表格。
			 */
			var nsrsbh = parentTabWindow.$("#renwuForm").find("input[name='nsrsbh']").val(); //纳税人识别号
			var queryUrl = "../../../../chuKouHeTong/findPageByCondition?branch=0&noTranslate=1&examineStatus=2&state=1";
			//如果是代理版
			if(Number(parentTabWindow.isDaiLiBan)){
				queryUrl = "../../../../renwu/findCkhtByScqy?nsrsbh="+nsrsbh;
			}
			
			$buttons.eq(0).on("click",function(){
				var loadingIndex = "";
				queryData({
					columns: ckhtColumns,
					/*
					//data:result,
					data:{
						"success": true, 
					    "msg": null, 
					    "data": {
					        "pageSize": 10, 
					        "pageNo": 1, 
					        "totalCount": 0, 
					        "lastPageNo": 3, 
					        "nextPageNo": 2, 
					        "firstPage": false, 
					        "lastPage": false, 
					        "thisPageElements":array,
					        "thisPageLastElementNumber": 20,
					        "previousPageNo": 0, 
					        "thisPageFirstElementNumber": 11
					    }
					},
					*/
//					url:"../../../../chuKouHeTong/findPageByCondition?branch=0&noTranslate=1",
					//url:"../../../../renwu/findCkhtByScqy?nsrsbh="+nsrsbh,
					url : queryUrl,		
					$container:$table,
					singleSelect:true,
					//height : 310,
					toolbar : "",
					uniqueId:"ckht",
					onPageChange:function(pageNumber,pageSize){
						//$table.closest("div.fixed-table-container").height(310);
					},
					onPreBody : function(){
						loadingIndex = showLoading();
					},
					onPostBody:function(data){
						//if(selection!=null)$table.find("font[key='"+selection.cmcode+"']:eq(0)").closest("td").click();//维护上次的被选中行这次依然被选中
						//this.onPageChange();
						selectDefaultRow(data);
						closeLoading(loadingIndex);
					},
					onClickRow : function(row,$element,field){
						selection = row;
						$element.closest("tbody").find("td").css("backgroundColor","");
						$element.closest("tr").find("td").css("backgroundColor","#e1dddd");
					},
					onDblClickRow :function(row,$element,field){
						this.onClickRow(row,$element,field);
						$buttons.eq(2).click();
					}
				});
				$table.closest("div.tableBox").find("div.fixed-table-pagination").find('button[name="refresh"]').off("click").on("click",function(){
					$buttons.eq(0).click();
				});
			}).trigger("click");
			
			/**
			 @author 周小建
			 @time 2017-11-01
			 @description “出口合同”确定按钮的单击事件处理函数，将选中行回传给表单对象项。
			 */
			$buttons.eq(2).on("click",function(){
				//var selections = $hgTable.bootstrapTable("getSelections");
				if(selection == null){
					layer.msg("请选择一条出口合同！");
					return;
				}else{
					
					var $renwuForm = parentTabWindow.$("#renwuForm");
					
					var width= $renwuForm.find(":input[name='serviceType']").width()+2;
					var height= $renwuForm.find(":input[name='serviceType']").height()+2;
					
					var zhezhao = '<span style="border:0px solid red; display:block;position:absolute;left: 4px;top:0;width:'+width+'px;height:'+height+'px;z-index:2;"></span>';
					
					$renwuForm.find(":input[name='ckht']").val(selection.ckht);
					$renwuForm.find(":input[name='contractCode']").val(selection.contractCode);
					$renwuForm.find(":input[name='contractName']").val(selection.contractName);
					$renwuForm.find(":input[name='serviceType']").val(selection.serviceType).attr("readonly","readonly").after(zhezhao);
					$renwuForm.find(":input[name='destinationAreaName']").val(selection.arrivingCountry).attr("readonly","readonly").after(zhezhao);
					$renwuForm.find(":input[name='exportPortName']").val(selection.exportPort).attr("readonly","readonly").after(zhezhao);
					$renwuForm.find(":input[name='transportMode']").val(selection.transportMode).attr("readonly","readonly").after(zhezhao);
					
					//parentTabWindow.selectionHg = selection;
					//parent.layer.close(parent.layer.getFrameIndex(window.name));//成功后关闭页面
					//parent.layer.close(hgLayerIndex);
					finishCallback();
				}
			});
			
			/**
			 @author 周小建
			 @time 2017-11-01
			 @description “出口合同”撤销按钮的单击事件处理函数，取消选中并清除回传输入框。
			 */
			$buttons.eq(3).on("click",function(){
				layer.confirm("确定要撤销吗?",{btn:["确定"]},function(){
					var $renwuForm = parentTabWindow.$("#renwuForm");
					$renwuForm.find(":input[name='ckht']").val("");
					$renwuForm.find(":input[name='contractCode']").val("");
					$renwuForm.find(":input[name='contractName']").val("");
					$renwuForm.find(":input[name='serviceType']").val("").attr("readonly",false).nextAll("span").remove();
					$renwuForm.find(":input[name='destinationAreaName']").val("").attr("readonly",false).nextAll("span").remove();;
					$renwuForm.find(":input[name='exportPortName']").val("").attr("readonly",false).nextAll("span").remove();;
					$renwuForm.find(":input[name='transportMode']").val("").attr("readonly",false).nextAll("span").remove();;
					selection = null;
					$table.find("tbody td").css("backgroundColor","");
					//parentTabWindow.selectionHg = selection;
					//parent.layer.close(parent.layer.getFrameIndex(window.name));//成功后关闭页面
					//parent.layer.close(hgLayerIndex);
					finishCallback();
				});
			});
		});
	</script>
</body>
</html>