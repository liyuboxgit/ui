<!DOCTYPE HTML>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<!--Bootstrap 不支持 IE 古老的兼容模式。为了让 IE 浏览器运行最新的渲染模式建议添加一下meta-->
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<!--自适应设备宽度-->
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
		<title>外贸综合服务企业出口退税风险管控信息系统-进货数据的校验检查</title>
		<meta name="Keywords" content="外贸综合服务企业出口退税风险管控信息系统">
		<meta name="description" content="外贸综合服务企业出口退税风险管控信息系统">
		<link rel="stylesheet" href="../../../static/plugins/bootstrap-3.3.7/css/bootstrap.min.css"/>
		<script type="text/javascript" src="../../../static/plugins/jquery-2.1.1/jquery-2.1.1.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="../../../static/plugins/font-awesome-4.7.0/css/font-awesome.css"/><!-- icon字体图标 -->
		<link rel="stylesheet" href="../../../static/plugins/bootstrap-table-1.11.1/bootstrap-table.css"/><!-- 表格 -->
		<script type="text/javascript" src="../../../static/plugins/bootstrap-table-1.11.1/bootstrap-table.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-table-1.11.1/extensions/export/bootstrap-table-export.js"></script><!-- 表格导出 -->
		<script type="text/javascript" src="../../../static/plugins/tableExport.jquery.plugin/tableExport.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-table-1.11.1/locale/bootstrap-table-zh-CN.js"></script>
		<script type="text/javascript" src="../../../static/plugins/jquery-validation-1.17.0/jquery.validate.js"></script><!-- 表单验证 -->
		<script type="text/javascript" src="../../../static/plugins/jquery-validation-1.17.0/jquery.validate.extends.js"></script>
		<link rel="stylesheet" href="../../../static/plugins/poshytip-1.2/tip-yellowsimple/tip-yellowsimple.css" type="text/css"/>
		<script type="text/javascript" src="../../../static/plugins/poshytip-1.2/jquery.poshytip.js"></script>
		<script type="text/javascript" src="../../../static/js/common.js"></script><!-- 自定义公用js -->
		<link rel="stylesheet" href="../../../static/css/common.css"/><!-- 自定义公用css -->
		<link rel="stylesheet" href="../../../static/plugins/layer-v3.1.0/theme/default/layer.css"/><!-- 弹窗 -->
		<script type="text/javascript" src="../../../static/plugins/layer-v3.1.0/layer.js"></script>
		<script type="text/javascript" src="../../../static/plugins/My97DatePicker-4.8/WdatePicker.js"></script><!-- 日历 -->
	</head>
	<body style="overflow-y:hidden;background:#fff;">
		<div class="layerBodyBg">
			<form id="addInfoForm" class="form-horizontal layerForm" action=""  method="post" enctype="multipart/form-data">
				<!-- 基本信息 -->
				<div  class="tab-pane clearfix active" id="info"></div>
				<!-- 基本信息 -->
				<p class="text-center">
					<button type="reset" class="btn btn-ckts btn-sm"><i class="glyphicon glyphicon-repeat" style="margin-right:5px;"></i>重置</button>
					<button type="button" class="btn btn-ckts btn-sm" id="save"><i class="glyphicon glyphicon-saved" style="margin-right:5px;"></i>保存</button>
				</p>
				<input id="wmsbjh" type="hidden"/>
				<input id="sbpc" type="hidden"/>
			</form>
		</div>
		<script type="text/javascript"> 
			$(function(){
				//alert(parent.params.wmsbjh);
				$("#wmsbjh").val(parent.params.wmsbjh);
				$("#sbpc").val(parent.params.sbpc);
				//基本信息
				var config = {
					container:"info",
					columns:[
						{col:"glh",label:"关联号",type:"text",validate:{required:true},readonly:true},
						{col:"sz",label:"税种",type:"text",value:'C',readonly:true},
// 						{col:"gdh",label:"关单号",type:"text",display:false},
						{col:"bmdm",label:"部门代码",type:"text",readonly:true},
						{col:"bmmc",label:"部门名称",type:"text",readonly:true},
						{col:"sbny",label:"申报年月",type:"text",validate:{required:true},readonly:true},
						{col:"sbpch",label:"申报批次",type:"text",validate:{required:true},readonly:true},
						{col:"sjxh",label:"序号",type:"text",validate:{required:true}},
// 						{col:"fph",label:"发票号码",type:"text"},
// 						{col:"fpd",label:"发票代码",type:"text"},
						{col:"jhpzh",label:"进货凭证号",type:"text",validate:{required:true,number:true,minlength:18,maxlength:18},readonly:true},
// 						{col:"sbpch",label:"分批批次",type:"text"},
						{col:"xfnsrsbh",label:"供货方纳税号",type:"text",validate:{required:true},readonly:true},
						{col:"kprq",label:"发票开票日期",type:"date",validate:{required:true},readonly:true},
						{col:"spdm",label:"商品代码",type:"text",validate:{required:true},readonly:true},
// 						{col:"spmc",label:"商品名称",type:"text",validate:{required:true}},
// 						{col:"dw",label:"单位",type:"text",validate:{required:true}},
						{col:"sl",label:"数量",type:"text",validate:{required:true,number:true}},
						{col:"jsje",label:"计税金额 ",type:"text",validate:{required:true,number:true}},
						{col:"zsl",label:"法定征税税率 ",type:"text",validate:{required:true}},
						{col:"se",label:"税额",type:"text",validate:{required:true,number:true}},
						{col:"tsl",label:"退税率",type:"text",validate:{required:true}},
						{col:"ktse",label:"可退税额",type:"text",validate:{required:true}},
						{col:"zyfp",label:"专用税票号",type:"text",validate:{required:true,length:14}},
						{col:"ywdm",label:"业务代码",type:"text",readonly:true},
// 						{col:"ywlx",label:"业务类型",type:"select",options:getDicts("serviceType")},
						{col:"bz",label:"备注",type:"text",readonly:true},
						{col:"zhbz",label:"暂缓标志",type:"text"},
						{col:"bytsbz",label:"不予退税标志",type:"text"},
						{col:"bs",label:"标识",type:"text"},
						{col:"sbbz",label:"申报标志",type:"text"},
						{col:"tzbz",label:"调整标志",type:"text"}
					]
				};
				
				//基本信息添加到页面
				formGenerator(config);
				//验证表单
				registerValidate("addInfoForm",config);
				
				 $("#addInfoForm :input[name='sl']").on("blur",function(){
					 var sl = $(this).val();
					 var jsje = $("#addInfoForm :input[name='jsje']").val();
					 var zsl = $("#addInfoForm :input[name='zsl']").val();
					 var tsl = $("#addInfoForm :input[name='tsl']").val();
					 if(!jsje){
						 return;
					 }
					 var result = sl * jsje * zsl;
					 var res = sl * jsje * tsl;
					 $("#addInfoForm :input[name='se']").val(result.myToFixed(2));
					 $("#addInfoForm :input[name='ktse']").val(res.myToFixed(2));
				 });
				 
				 $("#addInfoForm :input[name='jsje']").on("blur",function(){
					 var jsje = $(this).val();
					 var sl = $("#addInfoForm :input[name='sl']").val();
					 var zsl = $("#addInfoForm :input[name='zsl']").val();
					 var tsl = $("#addInfoForm :input[name='tsl']").val();
					 if(!sl){
						 return;
					 }
					 var result = sl * jsje * zsl;
					 var res = sl * jsje * tsl;
					 $("#addInfoForm :input[name='se']").val(result.myToFixed(2));
					 $("#addInfoForm :input[name='ktse']").val(res.myToFixed(2));
				 });
				 
				
				$.ajax({
			        url:'../../../../sbpc/findJhDetail',
			        type:'GET',
			        dataType:'json',
			        data:{
			        	"uuid":parent.params.wmsbjh,
			        },
			        success:function(result){
	                   setFormData('addInfoForm',document,result.data);
	                   $("#addInfoForm :input[name='sz']").val("C");
	                   $("#addInfoForm :input[name='xfnsrsbh']").val("");
	                   $("#addInfoForm :input[name='sl']").val("");
	                   $("#addInfoForm :input[name='jsje']").val("");
	                   $("#addInfoForm :input[name='se']").val("");
	                   $("#addInfoForm :input[name='ktse']").val("");
			        },
			    })
			     $.ajax({
				        url:'../../../../sbpc/findXfsl',
				        type:'GET',
				        dataType:'json',
				        data:{
				        	"cmcode":parent.params.spdm,
				        	"uuid":parent.params.wmsbjh,
				        },
				        success:function(result){
// 				        	debugger
		                    if(result.data){
		                    	if((result.data.cjdlzs)!=0&&(result.data.cldezs)!=0){
		                    		$("#addInfoForm :input[name='zsl']").val("");
		                    		$("#addInfoForm :input[name='tsl']").val("");
		                    	}else{
					        		$("#addInfoForm :input[name='spmc']").val(result.data.stanName);
					        		$("#addInfoForm :input[name='zsl']").val((result.data.cldezs)==0?(result.data.cjdlzs):(result.data.cldezs));
					        		$("#addInfoForm :input[name='tsl']").val((result.data.cldezs)==0?(result.data.cjdlzs):(result.data.cldezs));
		                    	}	
		                    }
				        },
				    }) 
				//验证表单
				registerValidate("addInfoForm",config);

                //保存点击事件
				$("#save").on("click",function(){
                    var data = $("#addInfoForm").serialize();
                    $.ajax({
                        url : "../../../../sbpc/saveShangPinXiaoFeiShui?wmsbjhc="+parent.params.wmsbjh+"&sbpc="+parent.params.sbpc,
                        type : "post",
                        data : data,
                        dataType : "json",
                        success : function(res){
                            if(res.success){
                                layer.msg("保存成功!");
                                parent.layer.close(parent.layer.getFrameIndex(window.name));//成功后关闭页面
                       			//parent.refreshTable(); //刷新页面
                       			//parent.creategoodsList();
                       			parent.$("#xhrep").trigger("click");
                            } else {
                                layer.msg(res.msg);
                            }
                        }
                    });
				});
			});
		</script>
	</body>
</html>