<!DOCTYPE HTML>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<!--Bootstrap 不支持 IE 古老的兼容模式。为了让 IE 浏览器运行最新的渲染模式建议添加一下meta-->
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<!--自适应设备宽度-->
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
		<title>外贸综合服务企业出口退税风险管控信息系统-导入</title>
		<meta name="Keywords" content="外贸综合服务企业出口退税风险管控信息系统">
		<meta name="description" content="外贸综合服务企业出口退税风险管控信息系统">
		<link rel="stylesheet" href="../../../static/plugins/bootstrap-3.3.7/css/bootstrap.min.css"/>
		<script type="text/javascript" src="../../../static/plugins/jquery-2.1.1/jquery-2.1.1.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-3.3.7/js/bootstrap.min.js"></script>
		<link rel="stylesheet" href="../../../static/plugins/font-awesome-4.7.0/css/font-awesome.css"/><!-- icon字体图标 -->
		<link rel="stylesheet" href="../../../static/plugins/bootstrap-table-1.11.1/bootstrap-table.css"/><!-- 表格 -->
		<script type="text/javascript" src="../../../static/plugins/bootstrap-table-1.11.1/bootstrap-table.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-table-1.11.1/extensions/export/bootstrap-table-export.js"></script><!-- 表格导出 -->
		<script type="text/javascript" src="../../../static/plugins/tableExport.jquery.plugin/tableExport.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-table-1.11.1/locale/bootstrap-table-zh-CN.js"></script>
		<script src="../../../static/plugins/jquery.nicescroll-3.7.6/jquery.nicescroll.js"></script><!-- 美化滚动条 -->
		<script type="text/javascript" src="../../../static/js/common.js"></script><!-- 自定义公用js -->
		<link rel="stylesheet" href="../../../static/css/common.css"/><!-- 自定义公用css -->
		<link rel="stylesheet" href="../../../static/plugins/layer-v3.1.0/theme/default/layer.css"/><!-- 弹窗 -->
		<script type="text/javascript" src="../../../static/plugins/layer-v3.1.0/layer.js"></script>
		<!-- 文件上传 -->
		<link rel="stylesheet" href="../../../static/plugins/bootstrap-fileinput-4.4.6/css/fileinput.css"/>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-fileinput-4.4.6/js/fileinput.js"></script>
		<script type="text/javascript" src="../../../static/plugins/bootstrap-fileinput-4.4.6/js/locales/zh.js"></script>
		<!-- 文件上传 -->
		<style>
			.error-info{font-size: 12px;}
		</style>
	</head>
	<body>
		<div class="layerBodyBg" style="margin:0;">
			<p class="text-left" style="background:#f4f4f4; padding:5px;"><a href="javascript:downExcelmodel();"><span style="color: #6972ff;">下载文件模板</span></a></p>
			<div class="form-horizontal row" id="fujian"></div>
			<!-- 
			<div class="row">
				<label class="control-label col-xs-2 text-right" style="padding-top:7px; font-weight:normal;"><span class="text-danger">*</span>请选择:</label>
				<p class="col-xs-8"><input type="file" name="fname" class="file inputBtn"></p>
			</div>
			<input type="hidden" id="url" name="url"/>
			 -->
			<div class="error-info col-sm-12" id="message" style="height: 280px;overflow: auto;border: 1px solid #dedede;border-radios: 5px;margin-top: 25px;"></div>
		</div>
		<script>
			//上传的后台地址
			var branch = serchParam.branch || "";
			var type = serchParam.type || "ckht";
			var ckht = serchParam.ckht || "";
			var review = serchParam.review || 0;
			var url = "../../../../chuKouHeTong/multifileUpload?" + (type=="ckhthw"?("ckht="+ckht):("branch="+branch))+"&type="+type;
			/*
			if(typeof(serchParam.branch) != "undefined"){
				branch = serchParam.branch;
			}
			if(typeof(serchParam.type) != "undefined"){
				type = serchParam.type;
			}
			if(typeof(serchParam.review) != "undefined"){
				review = serchParam.review;
			}
            if(typeof(serchParam.ckht) != "undefined"){
                ckht = serchParam.ckht;
            }
			if(type == "ckhthw"){
			    url = url+"?ckht="+ckht+"&type="+type;
			}else{
				url = url+"?branch="+branch+"&type="+type;
			}
			console.log(url);
			
			//附件上传按钮
			$(".inputBtn").fileinput({
				language : "zh",
				showCaption : true,
				browseClass : "btn btn-default btn-sm",
				uploadExtraData : {branch:branch},
				dropZoneEnabled : false,
				showPreview : false,
                showUpload : false,
                showRemove : false,
				removeClass : "btn btn-default btn-sm",
				uploadClass : "btn btn-default btn-sm",
				uploadUrl : url,
			}).on("change",function(e,file){//
				//$(this).fileinput('refresh', {uploadExtraData : {id: 246}});//传入额外的参数
			}).on("filebatchselected",function(event,files){
				var fileName = files[0].name;
				if(fileName.indexOf("xlsx") != -1 || fileName.indexOf("xls") != -1){
	                $(this).fileinput("upload");
				}else{
					//parent.layer.msg("文件格式错误！,请下载模板！");
					//$('<p style="margin-top:10px;"><a href="">文件.xlsx</a><a style="margin-left:10px;" href="javascript:;" class="deleteFile"><i class="glyphicon glyphicon-remove"></i></a></p>').appendTo($(this).closest(".file-input")).find("a.deleteFile").off("click").on("click",function(){$(this).closest("p").remove();});
				}
            }).on("fileuploaded", function(event, data, previewId, index) { //上传成功后
				var result = data.response;
				if(result.success){
					if(result.msg) parent.layer.msg(result.msg);//提示
					if(review==1 && result.data!=null && result.data.length>0){
						for(var i=0;i<result.data.length;i++){ 
							result.data[i].seq = i;
							result.data[i].fpNumbers = result.data[i].numbers;
						}
						parent.dataCache.allCkhw = result.data;
						parent.isReview = true;
						var $container = parent.$("#ckhwTable");
						//parent.loadData($container,ckhwColumns,result.datas);
						$container.bootstrapTable("destroy").bootstrapTable({
							data:result.data,
							sidePagination:"client",
							classes : "table table-hover", // 添加样式名称
							striped : true, // 隔行变色
							//toolbar : "#optionsBtn",
							//toolbarAlign : "right",
							columns : parent.ckhwColumns,
							method: "post",
							clickToSelect : "true",
							contentType:"application/x-www-form-urlencoded; charset=UTF-8",
							buttonsClass : "info",
							pagination:false,
							onCheck:function(row, $element){
								$element.closest("tr").find("td").css("backgroundColor","#e1dddd");
							},
							onCheckAll:function(rows){
								//$table.find("tbody").find("*").css("backgroundColor","#e1dddd");
								$container.find("table:eq(0)").find("tbody").find("td").css("backgroundColor","#e1dddd");
							},
							onUncheck:function(row,$element){
								$element.closest("tr").find("td").css("backgroundColor","");
							},
							onUncheckAll:function(rows){
								//$table.find("tbody").find("*").css("backgroundColor","");
								$container.find("table:eq(0)").find("tbody").find("td").css("backgroundColor","");
							},
							onClickRow : function(row,$element,field){
								params = row;
							}
						});
					}
					//上传成功后
					//parent.layer.close(parent.layer.getFrameIndex(window.name));//成功后关闭页面 
		            parent.refreshTable(); //刷新页面
                    $(".kv-upload-progress").show();
				}else{
					//parent.layer.msg("上传失败");//提示
                    $(".kv-upload-progress").hide();
				}
				var message = '';
				var data = result.data;
				$.each(data,function (index,item) {
					message += item+'<br/>'
                });
				console.log(message);
				$("#message").html(message);
			}).on("fileerror",function(e,data,msg){
                //layer.msg("上传失败!");
            });
			*/
			
			//附件信息
			var fjConfig = {
			    container:"fujian",
			    columns:[
			    	{
			    		col:"fname",label:"导入文件",type:"import",name:"fname",sm:2,fileStyle:"xlsx|xls",uploadExtraData:{branch:branch},uploadUrl:url,
			    		fileuploadedHandler:function(data){
			    			var result = data.response;
							if(result.success){
								if(result.msg) parent.layer.msg(result.msg);//提示
								if(review==1 && result.data!=null && result.data.length>0){
									for(var i=0;i<result.data.length;i++){ 
										result.data[i].seq = i;
										result.data[i].fpNumbers = result.data[i].numbers;
									}
									parent.dataCache.allCkhw = result.data;
									parent.isReview = true;
									var $container = parent.$("#ckhwTable");
									//parent.loadData($container,ckhwColumns,result.datas);
									$container.bootstrapTable("destroy").bootstrapTable({
										data:result.data,
										sidePagination:"client",
										classes : "table table-hover", // 添加样式名称
										striped : true, // 隔行变色
										//toolbar : "#optionsBtn",
										//toolbarAlign : "right",
										columns : parent.ckhwColumns,
										method: "post",
										clickToSelect : "true",
										contentType:"application/x-www-form-urlencoded; charset=UTF-8",
										buttonsClass : "info",
										pagination:false,
										onCheck:function(row, $element){
											$element.closest("tr").find("td").css("backgroundColor","#e1dddd");
										},
										onCheckAll:function(rows){
											//$table.find("tbody").find("*").css("backgroundColor","#e1dddd");
											$container.find("table:eq(0)").find("tbody").find("td").css("backgroundColor","#e1dddd");
										},
										onUncheck:function(row,$element){
											$element.closest("tr").find("td").css("backgroundColor","");
										},
										onUncheckAll:function(rows){
											//$table.find("tbody").find("*").css("backgroundColor","");
											$container.find("table:eq(0)").find("tbody").find("td").css("backgroundColor","");
										},
										onClickRow : function(row,$element,field){
											params = row;
										}
									});
								}
								//上传成功后
								//parent.layer.close(parent.layer.getFrameIndex(window.name));//成功后关闭页面 
					            parent.refreshTable(); //刷新页面
			                    $(".kv-upload-progress").show();
							}else{
								//parent.layer.msg("上传失败");//提示
			                    $(".kv-upload-progress").hide();
							}
							var message = '';
							var data = result.data;
							$.each(data,function (index,item) {
								message += item+'<br/>'
			                });
							console.log(message);
							$("#message").html(message);
			    		}
			    	}
			    ]
			};
		    formGenerator(fjConfig,"single");
			
            function downExcelmodel(){
                var filename = '';
                if(type == 'ckht'){
                    filename = '出口合同模板0001.xlsx';
				}else{
                    filename = '出口合同货物模板0002.xlsx';
				}
                window.location.href = "../../../../attachment/exclemodel?filename="+filename;
            }
		</script>
	</body>
</html>